---
title: "R Notebook"
output: html_notebook
---

```{r}
rm(list=ls())
library(tidyverse)
library(reshape2)
library(rstan)
library(latex2exp)
library(caret)
library(gbm)
library(mvtnorm)
options(mc.cores=4)
rstan_options(auto_write = TRUE)
source("monitornew.R")

caretGrid <- expand.grid(interaction.depth=c(3), n.trees = 50,
                   shrinkage=c(0.1),
                   n.minobsinnode=10)

f_fit_gbm_predict <- function(r){
  rand_samples <- sample(1:nrow(r), 0.7 * nrow(r))
  training_data <- r[rand_samples, ]
  testing_data <- r[-rand_samples, ]

  gbmFit1 <- train(chain ~ ., data = training_data, 
                 method = "gbm",
                 trControl = trainControl(method = 'none'), 
                    tuneGrid = caretGrid, verbose=FALSE)
  plda <- predict(object=gbmFit1, newdata=testing_data)
  plda_prob <- predict(object=gbmFit1, newdata=testing_data, type = "prob")
  a_accuracy <- 
    tibble(predicted=plda, actual=testing_data$chain) %>%
    mutate(correct=if_else(predicted==actual, 1, 0)) %>% 
    summarise(mean(correct)) %>% 
    pull()
  return(list(accuracy=a_accuracy, predicted_prob=plda_prob, testing_data=testing_data))
}

f_r_star_distribution <- function(nsim, pred_test_prob, testing_data){
   
  mAccuracy <- matrix(nrow = nrow(pred_test_prob),
                    ncol = nsim)
  for(j in 1:nrow(pred_test_prob)){
    test <- apply(rmultinom(nsim, 1, prob = pred_test_prob[j, ]), 2, function(x) which(x==1))
    mAccuracy[j, ] <- if_else(test==testing_data$chain[j], 1, 0)
  }
  return(colMeans(mAccuracy) * n_distinct(testing_data$chain))
}


source("eight_schools.data.R")
eight_schools <- list(J=J, y=y, sigma=sigma)
model_cp <- stan_model("eight_schools_cp.stan")
model_ncp <- stan_model("eight_schools_ncp.stan")
```

Run models
```{r}
fit_cp <- sampling(
  model_cp, data = eight_schools,
  iter = 2000, chains = 4, seed = 483892929, refresh = 0,
  control = list(adapt_delta = 0.95)
)

fit_ncp <- sampling(
  model_ncp, data = eight_schools,
  iter = 2000, chains = 4, seed = 483892929, refresh = 0,
  control = list(adapt_delta = 0.95)
)
```

## Break each chain into two then make flattened data
Centered
```{r}
x <- rstan::extract(fit_cp, permuted=F)

r_star_centered <- r_star_dist(x)
```

Noncentered
```{r}
x <- rstan::extract(fit_ncp, permuted=F)
r_star_noncentered <- r_star_dist(x)
```

Store both
```{r}
c_df <- tibble(centered=r_star_centered,
               non_centered=r_star_noncentered)
```

## Trying with original data (i.e. 4 chains)
```{r}
x <- rstan::extract(fit_cp, permuted=F)
r_star_centered <- r_star_dist(x)

# noncentered
x <- rstan::extract(fit_ncp, permuted=F)
r_star_noncentered <- r_star_dist(x)
```

```{r}
d_df <- tibble(centered=r_star_centered,
               non_centered=r_star_noncentered)
```

Plot two R* distributions
```{r}
g1 <- 
  c_df %>% 
  melt(id.vars=NULL) %>% 
  ggplot(aes(x=value, fill=as.factor(variable))) +
  geom_histogram(position="identity", alpha=0.8) +
  xlim(0.78, 1.6) +
  scale_fill_grey("Series", labels=c("centered", "non-centered")) +
  xlab(TeX("$R*$")) +
  ylab("Count") +
  geom_vline(xintercept = 1, linetype=2) +
  ggtitle("A.") +
  theme(text = element_text(size=14, colour="black"),
        legend.position = "none")
g2 <- 
  d_df %>% 
  melt(id.vars=NULL) %>% 
  ggplot(aes(x=value, fill=as.factor(variable))) +
  geom_histogram(position="identity", alpha=0.8) +
  scale_fill_grey("Series", labels=c("centered", "non-centered")) +
  xlim(0.78, 1.6) +
  xlab(TeX("$R*$")) +
  ylab("Count") +
  geom_vline(xintercept = 1, linetype=2) +
  ggtitle("B.") +
  theme(text = element_text(size=14, colour="black"))
# a_df <- readRDS("../output/eight_schools_replicates_4_index.rds")

# pdf("../output/eight_schools.pdf", width = 12, height = 6)
# multiplot(g1, g2, cols = 2)
# dev.off()
```

# Plot R* versus quantiles
```{r}
x <- rstan::extract(fit_cp, permuted=F)
g1 <- plot_r_star_quantiles(1, x, nsim=40, split_chains = F) +
  scale_y_continuous(limits = c(0.6, 1.7), breaks = c(0.6, 0.8, 1, 1.2, 1.4, 1.6))

g2 <- plot_r_star_quantiles(2, x, nsim=40, split_chains = F) +
  scale_y_continuous(limits = c(0.6, 1.7), breaks = c(0.6, 0.8, 1, 1.2, 1.4, 1.6))

library(ggExtra)
f <- ecdf(x[, , 2])
p <- x[, , 2] %>% 
  melt(id.vars="NULL") %>% 
  mutate(value=f(value)) %>% 
  ggplot(aes(x=iterations, y=value, colour=as.factor(chains))) +
  geom_line(alpha=0.8) +
  geom_point(aes(size=NA)) +
  scale_size_identity() +
  scale_color_brewer(palette = "Dark2") +
  theme(text = element_text(colour="black", size=11),
          axis.text = element_text(colour="black", size=10),
        legend.position = "none",
        axis.title.x = element_blank()) +
  xlab("Iteration") +
  ylab("Quantile") +
  ylim(0, 1) +
  coord_flip()
ga <- ggMarginal(p, type="density", margins="x", groupColour = T,
                 xparams = list(bw=0.05))

f <- ecdf(x[, , 1])
p <- x[, , 1] %>% 
  melt(id.vars="NULL") %>% 
  mutate(value=f(value)) %>% 
  ggplot(aes(x=iterations, y=value, colour=as.factor(chains))) +
  geom_line(alpha=0.8) +
  geom_point(aes(size=NA)) +
  scale_size_identity() +
  scale_color_brewer(palette = "Dark2") +
  theme(text = element_text(colour="black", size=11),
          axis.text = element_text(colour="black", size=10),
        legend.position = "none",
        axis.title.x = element_blank()) +
  xlab("Iteration") +
  ylab("Quantile") +
  ylim(0, 1) +
  coord_flip()
gb <- ggMarginal(p, type="density", margins="x", groupColour = T,
                 xparams = list(bw=0.05))

library(cowplot)

pdf("../output/eight_schools_r_star_quantiles.pdf", width = 6, height = 6)
plot_grid(arrangeGrob(gb, top="A."), arrangeGrob(ga, top="B."), g1, g2,nrow = 2, rel_heights = c(1/2, 1/4))
dev.off()
```

