---
title: "R Notebook"
output: html_notebook
---

```{r}
rm(list=ls())
library(tidyverse)
library(reshape2)
library(rstan)
library(latex2exp)
library(caret)
library(gbm)
options(mc.cores=4)
rstan_options(auto_write = TRUE)
source("monitornew.R")
source("r_star_monitor.R")
```

Create a discrete Markov chain
```{r}
f_simulate_markov_chain <- function(L, P, state_0){
  states <- vector(length=L)
  states[1] <- state_0
  for(i in 2:L){
    p  <- P[states[i - 1], ]
    states[i] <-  which(rmultinom(1, 1, p) == 1)
  }
  return(states)
}

P <- matrix(nrow = 4, ncol = 4)
P[1, ] <- c(0, 1/2, 1/2, 0)
P[2, ] <- c(1/2, 0, 1/3, 1/6)
P[3, ] <- c(1/4, 1/4, 1/4, 1/4)
P[4, ] <- c(1/2, 0, 0, 1/2)
 
states <- f_simulate_markov_chain(100, P, 1)
plot(states, type="l")
```

Create 3 Markov chains with same transition matrix; one with a slightly different one
```{r}
f_generate_four <- function(L, P0, P1, state_0){
  x <- matrix(nrow = L, ncol = 4)
  for(i in 1:3)
    x[, i] <- f_simulate_markov_chain(L, P0, state_0)
  x[, 4] <- f_simulate_markov_chain(L, P1, state_0)
  return(x)
}

P0 <- P
P1 <- matrix(nrow = 4, ncol = 4)
P1[1, ] <- c(0, 1/2, 1/2, 0)
P1[2, ] <- c(1/2, 0, 1/3, 1/6)
P1[3, ] <- c(1/4, 1/4, 1/4, 1/4)
P1[4, ] <- c(1/2, 0, 1/6, 1/3)

f_generate_four(1000, P0, P1, 1) %>% 
  as.data.frame() %>% 
  rename(chain_1=V1, chain_2=V2, chain_3=V3, chain_4=V4) %>% 
  mutate(iter=seq_along(chain_1)) %>% 
  melt(id.vars="iter") %>% 
  group_by(variable) %>% 
  summarise(state_1=mean(value==1),
            state_2=mean(value==2),
            state_3=mean(value==3),
            state_4=mean(value==4)) %>% 
  pivot_longer(cols=state_1:state_4) %>% 
  ggplot(aes(x=as.factor(name), fill=as.factor(variable), y=value)) +
  geom_col(position = position_dodge()) +
  xlab("State") +
  ylab("Frequency") +
  scale_fill_brewer("Chain", palette = "Dark2")
```

Generate replicates and calculate R* on these
```{r}
f_replicate <- function(L, P0, P1, state_0){
  temp <- f_generate_four(L, P0, P1, state_0)
  a_array <- array(dim=c(L, 4, 1))
  a_array[,,1] <- temp
  a_accuracy <- r_star(a_array)
  mon <- monitor_extra(split_data(a_array))
  return(list(r_star=a_accuracy, r_hat=mon$zfsRhat))
}

nreplicates <- 20
Ls <- c(1000, 2000, 5000, 10000)

# create P1 matrices
f_create_P1_example <- function(last_val=1/2){
  P1 <- matrix(nrow = 4, ncol = 4)
  P1[1, ] <- c(0, 1/2, 1/2, 0)
  P1[2, ] <- c(1/2, 0, 1/3, 1/6)
  P1[3, ] <- c(1/4, 1/4, 1/4, 1/4)
  P1[4, ] <- c(1/2, 0, (1 - 1/2 - last_val), last_val)
  return(P1)
}

last_vals <- c(0, 0.25, 0.5)
P1s <- map(last_vals, ~f_create_P1_example(.))

r_star_vals <- matrix(nrow=nreplicates * length(Ls) * length(P1s), ncol=4)
r_hat_vals <- matrix(nrow=nreplicates * length(Ls) * length(P1s), ncol=4)
counter <- 1
for(k in 1:length(P1s)){
  for(j in seq_along(Ls)){
    print(paste0("k=", k, ", j=", j))
    for(i in 1:nreplicates){
      temp <- f_replicate(Ls[j], P0, P1s[[k]], 1)
      r_star_vals[counter, ] <- c(k, Ls[j], i, temp$r_star)
      r_hat_vals[counter, ] <- c(k, Ls[j], i, temp$r_hat)
      counter <- counter + 1
    }
  }
}
colnames(r_hat_vals) <- c("P1", "sample size", "iter", "value")
colnames(r_star_vals) <- c("P1", "sample size", "iter", "value")
r_hat_vals <- as.data.frame(r_hat_vals) %>% 
  mutate(type="Split-Rhat")
r_star_vals <- as.data.frame(r_star_vals) %>% 
  mutate(type="R*")

saveRDS(tibble(r_star=r_star_vals, r_hat=r_hat_vals), "../data/discrete_r_star_hat.rds")
```

Plot
```{r}
a_sum <- r_star_vals %>%
  group_by(P1, `sample size`, type) %>%
  summarise(lower=quantile(value, 0.025),
         upper=quantile(value, 0.975),
         middle=quantile(value, 0.5))
r_star_vals %>% 
  left_join(a_sum) %>% 
  ggplot(aes(x=as.factor(`sample size`), y=value)) +
  geom_jitter(width = 0.2, colour="grey") +
  geom_pointrange(aes(ymin=lower, y=middle, ymax=upper)) +
  facet_grid(vars(P1)) +
  geom_hline(yintercept = 1, linetype=2) +
  scale_y_continuous(limits=c(0.9, 1.2))
```

